{% extends "base.html" %}

{% block extrahead %}
<style>
#pageimage {
  background: url(/doc/cached/{{doc_id}}/{{page}});
  background-repeat: no-repeat;
  background-size: 1170px;
  width: 1170px;
  height: 1500px;
  overflow: hidden;
}

#highlight {
  position: relative;
  float: left;
  border: 3px solid #C00000;
  overflow: hidden;
  display: none;
}

#overlay {
  background: rgba(200,200,200,0.8);
  position: relative;
  float: left;
  border: 2px solid #000000;
  overflow: visible;
  display: none;
}

</style>
{% endblock %}

{% block body %}
<div class="container">
  <div class="row">
    <div id="pageimage">
      <div id="highlight"> </div>
      <div class="row">
      <div id="overlay" class="col-md-6 col-md-offset-3">
          <div class="col-md-6">
          <p>OCR'd text:</p>
          <pre id="ocrtext"></pre>
          </div>
          <div class="col-md-6">
          <p>Review text:</p>
          <form class="form" role="form" name="textform" method="post">
            <div class="form-group">
              <input type="hidden" name="segment_id" value="-1">
              <label class="sr-only" for="usertext">Correct OCR text:</label>
              <textarea id="usertext" name="usertext" class="form-control" rows="2"></textarea>
              <button type="submit" class="btn btn-success" value="save" name="save" id="savebutton"><i class="fa fa-check"></i> Save</button>
              <button type="input" class="btn btn-default" value="skip" name="skip" id="skipbutton"><i class="fa fa-forward"></i> Skip</button>
              <button type="input" class="btn btn-warning" value="undo" name="undo" id="undobutton"><i class="fa fa-undo"></i> Undo</button>
            </div>
          </form>
          </div>
      </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extrafooter%}
<script type="text/javascript">
$(function() {

    var segdata = {{segdata|safe}};
    var imgw = 3510.0;
    var imgh = 2482.0;

    var img = document.getElementById('pageimage');
    var img_cw = img.clientWidth;
    var img_ch = 827; //img.clientHeight;

    var scale_x = img_cw / imgw;
    var scale_y = img_ch / imgh;

    var highlight = $('#highlight');
    var overlay = $('#overlay');
    var ocrtext = $('#ocrtext');
    var usertext = $('#usertext');

    var lastsegid = null;
    var segno = -1;

    function setbox(seg) {
        var x1 = Math.round(seg.x1 * scale_x);
        var y1 = Math.round(seg.y1 * scale_y);
        var x2 = Math.round(seg.x2 * scale_x);
        var y2 = Math.round(seg.y2 * scale_y);

        highlight.css('top', '' + y1-3 + 'px');
        highlight.css('left', '' + x1-3 + 'px');
        highlight.css('width', '' + (x2-x1+3) + 'px');
        highlight.css('height', '' + (y2-y1+3) + 'px');

        overlay.css('top', '' + y2 + 'px');
        overlay.css('margin-right', '25%');
        console.log('Block: ' + x1 + ',' + y1 + ' - ' + x2 + ','+ y2 + 'px');
        usertext.val(seg.text);
        usertext.attr('rows', String(seg.textlines));
        ocrtext.text(seg.ocrtext);

        document.getElementById("usertext").focus();
        window.scrollTo(0, y1-300);
    }

    function nextsegment() {
        if (segno >= 0) {
            lastsegid = segdata[segno].segment_id;
        }
        if (segno < segdata.length-1) {
            segno++;
            setbox(segdata[segno]);
        }
        return segno <= segdata.length;
    }

    function checkfornextpage() {
        return true;
    }

    nextsegment();
    highlight.css('display', 'inline');
    overlay.css('display', 'inline');

    $('#undobutton').click(function(e) {
        if (!lastsegid) {
            return;
        }
        e.preventDefault()
    });

    $('#skipbutton').click(function(e) {
        $.get('/api/review/' + segdata[segno].segment_id, {skip: true}).always(checkfornextpage());
        nextsegment();
        e.preventDefault()
    });

    $('#savebutton').click(function(e) {
        $.get('/api/review/' + segdata[segno].segment_id, {text: usertext.val()}).done(checkfornextpage());
        nextsegment();
        e.preventDefault()
    });

});
</script>
{% endblock %}
